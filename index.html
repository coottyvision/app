<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coottyvision Delivery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f1f5f9; }
        .app-frame { max-width: 480px; margin: 0 auto; background-color: #ffffff; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .card-order { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-order:active { transform: scale(0.98); }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .map-overlay { background: linear-gradient(to top, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%); }
    </style>
</head>
<body>

    <div class="app-frame flex flex-col overflow-hidden">
        
        <div id="view-loading" class="fixed inset-0 z-[60] bg-slate-900 flex flex-col items-center justify-center app-frame">
            <div class="w-16 h-16 bg-teal-500/20 rounded-full flex items-center justify-center mb-4 relative">
                <i data-lucide="loader-2" class="w-8 h-8 text-teal-400 animate-spin"></i>
                <div class="absolute inset-0 border-4 border-teal-500/30 rounded-full animate-pulse"></div>
            </div>
            <p class="text-slate-400 text-sm font-medium tracking-wide">Iniciando sistema...</p>
        </div>

        <div id="view-login" class="fixed inset-0 z-50 bg-slate-900 flex flex-col p-8 app-frame hidden">
            <div class="flex-1 flex flex-col justify-center">
                <div class="w-20 h-20 bg-gradient-to-tr from-teal-500 to-emerald-400 rounded-3xl flex items-center justify-center mb-8 shadow-2xl shadow-teal-500/20">
                    <i data-lucide="navigation" class="w-10 h-10 text-white"></i>
                </div>
                <h1 class="text-4xl font-extrabold text-white mb-2 tracking-tight">Cootty<br><span class="text-teal-400">Driver</span></h1>
                <p class="text-slate-400 text-lg mb-10">Env√≠os r√°pidos y seguros.</p>
                <form id="login-form" class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase ml-1">Email</label>
                        <input type="email" id="login-email" class="w-full bg-slate-800 border border-slate-700 rounded-2xl px-5 py-4 text-white focus:ring-2 focus:ring-teal-500 outline-none transition-all font-medium" placeholder="">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase ml-1">Contrase√±a</label>
                        <input type="password" id="login-pass" class="w-full bg-slate-800 border border-slate-700 rounded-2xl px-5 py-4 text-white focus:ring-2 focus:ring-teal-500 outline-none transition-all font-medium" placeholder="">
                    </div>
                    <button type="submit" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-teal-500/20 active:scale-95 transition-transform mt-4 text-lg">Iniciar</button>
                </form>
            </div>
            <p class="text-center text-slate-400 text-xs">v0.0.1 Beta</p>
            <p class="text-center text-slate-400 text-xs">En desarrollo por Marco Montoro</p>


        </div>

        <div id="view-app" class="hidden flex-1 flex flex-col h-full bg-slate-50 relative">
            
            <header class="bg-white px-6 py-4 flex justify-between items-center sticky top-0 z-20 shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07)]">
                <div>
                    <h2 class="text-xl font-extrabold text-slate-800 tracking-tight">Ruta del D√≠a</h2>
                    <p class="text-xs font-medium text-slate-500 flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> <span id="pending-count">Sincronizando...</span></p>
                </div>
                <button onclick="logout()" class="w-10 h-10 rounded-full bg-slate-50 hover:bg-red-50 flex items-center justify-center border border-slate-200 transition-colors group">
                    <i data-lucide="power" class="w-5 h-5 text-slate-400 group-hover:text-red-500"></i>
                </button>
            </header>

            <div class="bg-white border-b border-slate-100 py-3 px-4">
                <div class="flex gap-2 overflow-x-auto no-scrollbar" id="district-filters">
                    <button class="bg-slate-900 text-white px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap">Todos</button>
                </div>
            </div>

            <div id="orders-container" class="flex-1 overflow-y-auto p-4 space-y-3 pb-24 no-scrollbar">
                <div class="flex flex-col items-center justify-center h-64 text-slate-300">
                    <i data-lucide="map" class="w-12 h-12 mb-3 opacity-20"></i>
                    <p class="text-sm font-medium">Buscando entregas...</p>
                </div>
            </div>

            <div class="absolute bottom-0 w-full bg-white border-t border-slate-100 p-4 pb-6 shadow-[0_-10px_40px_rgba(0,0,0,0.05)] z-20 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-teal-50 p-2.5 rounded-xl text-teal-600"><i data-lucide="check-circle-2" class="w-6 h-6"></i></div>
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Completados</p>
                        <p class="text-lg font-extrabold text-slate-800 leading-none" id="stats-completed">0</p>
                    </div>
                </div>
                <button onclick="window.location.reload()" class="bg-slate-900 p-3 rounded-full text-white shadow-lg active:rotate-180 transition-transform"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
            </div>
        </div>

        <div id="modal-delivery" class="fixed inset-0 z-50 hidden bg-slate-900/90 backdrop-blur-md flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl relative slide-up shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
                
                <div class="h-48 bg-slate-200 relative group">
                    <iframe id="d-map-frame" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" frameborder="0" style="border:0" allowfullscreen></iframe>
                    <div class="absolute inset-0 pointer-events-none map-overlay"></div>
                    <button onclick="closeModal()" class="absolute top-4 right-4 bg-white/90 backdrop-blur p-2 rounded-full shadow-sm hover:bg-white transition-all z-10"><i data-lucide="x" class="w-5 h-5 text-slate-600"></i></button>
                    <div class="absolute bottom-4 left-6 z-10">
                        <span class="bg-slate-900 text-white text-[10px] font-bold px-2 py-1 rounded-md uppercase tracking-wider mb-1 inline-block" id="d-dist">Distrito</span>
                        <h2 class="text-2xl font-extrabold text-slate-900 leading-none" id="d-name">Cliente</h2>
                    </div>
                </div>

                <div class="p-6 overflow-y-auto no-scrollbar space-y-6 bg-white flex-1">
                    
                    <div class="flex gap-4">
                        <div class="mt-1"><div class="w-8 h-8 rounded-full bg-teal-50 flex items-center justify-center text-teal-600"><i data-lucide="map-pin" class="w-4 h-4"></i></div></div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-slate-500">Direcci√≥n de entrega</p>
                            <p class="text-base font-bold text-slate-800 leading-snug mt-0.5" id="d-address">...</p>
                            <p class="text-xs text-slate-400 mt-1 italic" id="d-ref">...</p>
                        </div>
                        <button onclick="openGPS()" class="h-10 px-4 bg-slate-100 hover:bg-slate-200 rounded-xl font-bold text-xs text-slate-700 transition-colors">GPS</button>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="contact('wsp')" class="flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold transition-all shadow-lg shadow-green-500/20 active:scale-95">
                            <i data-lucide="message-circle" class="w-5 h-5"></i> WhatsApp
                        </button>
                        <button onclick="contact('call')" class="flex items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 py-3 rounded-xl font-bold transition-all active:scale-95">
                            <i data-lucide="phone" class="w-5 h-5"></i> Llamar
                        </button>
                    </div>

                    <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xs font-bold text-slate-400 uppercase">Pedido</span>
                            <span class="text-xs font-mono font-bold text-slate-400" id="d-id">#ID</span>
                        </div>
                        <div id="d-items" class="space-y-2 mb-4 border-b border-slate-200 pb-4"></div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-bold text-slate-700">Total a Cobrar</span>
                            <span class="text-xl font-extrabold text-slate-900">S/<span id="d-total">0.00</span></span>
                        </div>
                    </div>

                    <div class="space-y-3 pt-2">
                        <button id="btn-photo" onclick="triggerCamera()" class="w-full border-2 border-dashed border-slate-300 text-slate-500 py-3 rounded-xl font-bold text-sm hover:border-teal-500 hover:text-teal-600 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="camera" class="w-5 h-5"></i> <span id="photo-text">Adjuntar Foto de Entrega</span>
                        </button>
                        <input type="file" id="file-input" accept="image/*" capture="environment" class="hidden" onchange="photoTaken()">

                        <div class="grid grid-cols-4 gap-3">
                            <button onclick="toggleIssueMenu()" class="col-span-1 bg-red-50 text-red-500 rounded-xl flex items-center justify-center hover:bg-red-100 transition-colors">
                                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                            </button>
                            <button onclick="completeOrder()" id="btn-complete" class="col-span-3 bg-slate-900 text-white py-4 rounded-xl font-bold text-lg shadow-xl shadow-slate-900/20 active:scale-95 transition-transform flex items-center justify-center gap-2">
                                Confirmar Entrega <i data-lucide="check" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="issue-menu" class="absolute inset-0 bg-white z-20 transform translate-y-full transition-transform duration-300 flex flex-col p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-slate-900">Reportar Problema</h3>
                        <button onclick="toggleIssueMenu()" class="p-2 bg-slate-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <div class="space-y-3 flex-1">
                        <button onclick="reportIssue('client_absent')" class="w-full p-4 text-left bg-slate-50 hover:bg-red-50 rounded-xl font-bold text-slate-700 hover:text-red-600 border border-slate-100 transition-colors">üè† Cliente no est√° / No contesta</button>
                        <button onclick="reportIssue('wrong_address')" class="w-full p-4 text-left bg-slate-50 hover:bg-red-50 rounded-xl font-bold text-slate-700 hover:text-red-600 border border-slate-100 transition-colors">üìç Direcci√≥n incorrecta</button>
                        <button onclick="reportIssue('refused')" class="w-full p-4 text-left bg-slate-50 hover:bg-red-50 rounded-xl font-bold text-slate-700 hover:text-red-600 border border-slate-100 transition-colors">‚õî Pedido rechazado</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCWCM5aXMS8OgcJ5vEES6WV17Hhymfngyw", authDomain: "coottyvision-hd.firebaseapp.com", projectId: "coottyvision-hd", storageBucket: "coottyvision-hd.firebasestorage.app", messagingSenderId: "204138808996", appId: "1:204138808996:web:ff65a968cd5853d52e0831" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

        let activeOrders = []; let selectedOrder = null; let hasPhoto = false; let filterDistrict = 'Todos';

        onAuthStateChanged(auth, user => {
            document.getElementById('view-loading').classList.add('hidden');
            if(user) { document.getElementById('view-login').classList.add('hidden'); document.getElementById('view-app').classList.remove('hidden'); initListener(); } 
            else { document.getElementById('view-login').classList.remove('hidden'); document.getElementById('view-app').classList.add('hidden'); }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => { e.preventDefault(); const btn = e.target.querySelector('button'); const txt = btn.innerText; btn.innerText="Verificando..."; btn.disabled=true; try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value); } catch(e) { alert("Acceso denegado"); btn.innerText=txt; btn.disabled=false; } });
        window.logout = () => signOut(auth);

        function initListener() {
            // Escuchar pedidos 'shipped' (En Ruta) y 'processing' (En Taller/Pendientes)
            const q = query(collection(db, 'orders'));
            onSnapshot(q, (snap) => {
                const all = snap.docs.map(d => ({id: d.id, ...d.data()}));
                // Filtrar lo que le interesa al driver
                activeOrders = all.filter(o => ['shipped', 'processing'].includes(o.status));
                // Calcular stats
                const completed = all.filter(o => o.status === 'completed' && isToday(o.deliveredAt)).length;
                document.getElementById('stats-completed').innerText = completed;
                
                renderFilters();
                renderList();
            });
        }
        
        function isToday(isoDate) { if(!isoDate) return false; const d = new Date(isoDate); const today = new Date(); return d.getDate() === today.getDate() && d.getMonth() === today.getMonth(); }

        function renderFilters() {
            const districts = ['Todos', ...new Set(activeOrders.map(o => (typeof o.customer === 'object' ? o.customer.district : 'General') || 'General'))];
            const container = document.getElementById('district-filters');
            container.innerHTML = districts.map(d => `<button onclick="setFilter('${d}')" class="${d === filterDistrict ? 'bg-slate-900 text-white shadow-md' : 'bg-white text-slate-600 border border-slate-200'} px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-all">${d}</button>`).join('');
        }

        window.setFilter = (d) => { filterDistrict = d; renderFilters(); renderList(); };

        function renderList() {
            const container = document.getElementById('orders-container');
            let filtered = filterDistrict === 'Todos' ? activeOrders : activeOrders.filter(o => {
                const d = typeof o.customer === 'object' ? o.customer.district : 'General';
                return (d || 'General') === filterDistrict;
            });

            document.getElementById('pending-count').innerText = `${filtered.length} Pendientes`;

            if(filtered.length === 0) { container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-300"><i data-lucide="check-circle" class="w-12 h-12 mb-3 opacity-20"></i><p class="text-sm font-medium">Zona limpia</p></div>`; lucide.createIcons(); return; }

            container.innerHTML = filtered.map(o => {
                const isNew = typeof o.customer === 'object';
                const name = isNew ? o.customer.name : o.customer;
                const district = isNew ? (o.customer.district || 'General') : 'General';
                const address = isNew ? o.customer.address : 'Ver detalle';
                const statusColor = o.status === 'shipped' ? 'bg-purple-100 text-purple-700' : 'bg-blue-50 text-blue-600';
                const statusText = o.status === 'shipped' ? 'EN RUTA' : 'EN TALLER';

                return `
                <div onclick="openOrder('${o.id}')" class="card-order bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4 cursor-pointer relative overflow-hidden group">
                    <div class="absolute left-0 top-0 bottom-0 w-1 ${o.status === 'shipped' ? 'bg-purple-500' : 'bg-blue-500'}"></div>
                    <div class="w-12 h-12 rounded-full bg-slate-50 flex items-center justify-center font-bold text-slate-600 border border-slate-100 text-lg flex-shrink-0 group-active:scale-90 transition-transform">
                        ${name.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start mb-0.5">
                            <h3 class="font-bold text-slate-800 text-sm truncate">${name}</h3>
                            <span class="text-[9px] font-bold px-1.5 py-0.5 rounded ${statusColor}">${statusText}</span>
                        </div>
                        <p class="text-xs text-slate-500 truncate"><i data-lucide="map-pin" class="w-3 h-3 inline text-teal-500"></i> ${district}</p>
                        <p class="text-[10px] text-slate-400 mt-1 truncate">${address}</p>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        // --- MODAL & ACTIONS ---
        window.openOrder = (id) => {
            selectedOrder = activeOrders.find(o => o.id === id);
            if(!selectedOrder) return;
            hasPhoto = false; document.getElementById('photo-text').innerText = "Adjuntar Foto de Entrega"; document.getElementById('btn-photo').className = "w-full border-2 border-dashed border-slate-300 text-slate-500 py-3 rounded-xl font-bold text-sm hover:border-teal-500 hover:text-teal-600 transition-colors flex items-center justify-center gap-2";

            const isNew = typeof selectedOrder.customer === 'object';
            const data = {
                name: isNew ? selectedOrder.customer.name : selectedOrder.customer,
                address: isNew ? selectedOrder.customer.address : 'Direcci√≥n antigua',
                ref: isNew ? selectedOrder.customer.ref : '',
                district: isNew ? selectedOrder.customer.district : 'Lima',
                city: isNew ? selectedOrder.customer.city : ''
            };

            document.getElementById('d-id').innerText = selectedOrder.orderId || '#'+selectedOrder.id.slice(0,5);
            document.getElementById('d-name').innerText = data.name;
            document.getElementById('d-dist').innerText = data.district;
            document.getElementById('d-address').innerText = data.address;
            document.getElementById('d-ref').innerText = data.ref;
            document.getElementById('d-total').innerText = parseFloat(selectedOrder.total).toFixed(2);
            document.getElementById('d-items').innerHTML = (selectedOrder.items||[]).map(i=>`<div class="flex justify-between text-xs text-slate-600"><span>${i.name}</span><span class="font-bold">S/${i.price}</span></div>`).join('');

            // Mapa Integrado (Truco iframe)
            const mapQ = encodeURIComponent(`${data.address}, ${data.district}, ${data.city}, Peru`);
            document.getElementById('d-map-frame').src = `https://maps.google.com/maps?q=${mapQ}&t=&z=15&ie=UTF8&iwloc=&output=embed`;

            document.getElementById('issue-menu').classList.add('translate-y-full');
            document.getElementById('modal-delivery').classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('modal-delivery').classList.add('hidden');
        window.openGPS = () => { if(!selectedOrder)return; const d=selectedOrder.customer; const q=encodeURIComponent(`${d.address}, ${d.district}, Peru`); window.open(`https://www.google.com/maps/dir/?api=1&destination=${q}`, '_blank'); };
        
        window.contact = (type) => {
            if(!selectedOrder) return;
            let phone = (typeof selectedOrder.customer === 'object' ? selectedOrder.customer.phone : null);
            if(!phone) return alert("Sin tel√©fono registrado.");
            phone = phone.replace(/\s/g,'');
            if(type==='wsp') window.open(`https://wa.me/51${phone}?text=${encodeURIComponent('Hola, estoy afuera con tu pedido de Coottyvision.')}`, '_blank');
            else window.open(`tel:${phone}`);
        };

        window.triggerCamera = () => document.getElementById('file-input').click();
        window.photoTaken = () => { hasPhoto = true; const btn = document.getElementById('btn-photo'); btn.className = "w-full bg-teal-50 border-2 border-teal-200 text-teal-700 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2"; document.getElementById('photo-text').innerText = "Foto Lista"; };

        window.completeOrder = async () => {
            if(!selectedOrder) return;
            if(!hasPhoto && !confirm("¬øConfirmar sin foto de evidencia?")) return;
            
            const btn = document.getElementById('btn-complete');
            const original = btn.innerHTML;
            btn.innerHTML = "Procesando..."; btn.disabled = true;

            try {
                await updateDoc(doc(db, 'orders', selectedOrder.id), { status: 'completed', deliveredAt: new Date().toISOString(), hasEvidence: hasPhoto });
                closeModal();
            } catch(e) { alert("Error de red"); } finally { btn.innerHTML = original; btn.disabled = false; }
        };

        window.toggleIssueMenu = () => document.getElementById('issue-menu').classList.toggle('translate-y-full');
        window.reportIssue = async (reason) => {
            if(!confirm("¬øReportar incidencia y cancelar entrega?")) return;
            try { await updateDoc(doc(db, 'orders', selectedOrder.id), { status: 'issue', issueReason: reason, issueAt: new Date().toISOString() }); closeModal(); } catch(e) { alert("Error"); }
        };

        lucide.createIcons();
    </script>
</body>
</html>
